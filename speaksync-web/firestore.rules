// Firestore Security Rules for SpeakSync Web App Feature Gating

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - basic profile data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Subscriptions collection - subscription data per user
    match /subscriptions/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId 
        && isValidSubscriptionData(request.resource.data);
    }
    
    // Free tier usage tracking
    match /freeTierUsage/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId
        && isValidUsageData(request.resource.data);
    }
    
    // Scripts collection - user's saved scripts
    match /scripts/{scriptId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        canCreateScript(request.auth.uid);
    }
    
    // Team scripts (for collaboration features)
    match /teamScripts/{scriptId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid in resource.data.collaborators);
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         hasEditPermission(request.auth.uid, resource.data));
    }
    
    // Analytics data (read-only for users)
    match /analytics/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Only server can write analytics
    }
  }
  
  // Helper functions
  function isValidSubscriptionData(data) {
    return data.keys().hasAll(['subscriptionTier', 'subscriptionStatus', 'subscriptionStartDate']) &&
           data.subscriptionTier in ['free', 'pro', 'studio'] &&
           data.subscriptionStatus in ['active', 'inactive', 'trialing', 'cancelled', 'grace_period'] &&
           data.subscriptionStartDate is number;
  }
  
  function isValidUsageData(data) {
    return data.keys().hasAll(['savedScriptsCount', 'sessionCount', 'totalSessionDuration', 'lastUpdated']) &&
           data.savedScriptsCount is number &&
           data.sessionCount is number &&
           data.totalSessionDuration is number &&
           data.lastUpdated is number;
  }
  
  function canCreateScript(userId) {
    let subscription = get(/databases/$(database)/documents/subscriptions/$(userId));
    let usage = get(/databases/$(database)/documents/freeTierUsage/$(userId));
    
    // If no subscription data, default to free tier
    if (!subscription.data) {
      return usage.data.savedScriptsCount < 1; // Free tier limit
    }
    
    // Pro and Studio tiers have unlimited scripts
    if (subscription.data.subscriptionTier in ['pro', 'studio']) {
      return true;
    }
    
    // Free tier has script limit
    return usage.data.savedScriptsCount < 1;
  }
  
  function hasEditPermission(userId, scriptData) {
    return userId == scriptData.userId || 
           (userId in scriptData.collaborators && 
            scriptData.collaborators[userId].canEdit == true);
  }
}
